#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Gerenciador de temas minimalista para Hyprland
#  Autor: Lucas Nascimento Hubner âœ¨
#  Estrutura esperada:
#  ~/.config/themes/<nome-do-tema>/{hypr, kitty, waybar, fastfetch}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -euo pipefail  # Para abortar em erros e variÃ¡veis nÃ£o definidas

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  DiretÃ³rios principais
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
THEMES_DIR="$HOME/.config/themes"
HYPR_DIR="$HOME/.config/hypr"
KITTY_DIR="$HOME/.config/kitty"
FASTFETCH_DIR="$HOME/.config/fastfetch"
WAYBAR_DIR="$HOME/.config/waybar"
FIREFOX_DIR="$HOME/.mozilla/firefox"
CURRENT_THEME="${1:-}"
HOME_WALLPAPERS="$HOME/wallpapers"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Cores para terminal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GREEN="\e[1;32m"
RED="\e[1;31m"
YELLOW="\e[1;33m"
BLUE="\e[1;34m"
RESET="\e[0m"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  FunÃ§Ãµes auxiliares
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

link_safe() {
    local src="$1"
    local dest="$2"
    local label="$3"

    if [ -e "$src" ]; then
        mkdir -p "$(dirname "$dest")"
        [ -e "$dest" ] && rm -rf "$dest"
        ln -sf "$src" "$dest"
        echo -e "${GREEN}âœ”${RESET} $label aplicado"
    else
        echo -e "${YELLOW}âš ${RESET} $label ausente em $src"
    fi
}

check_theme() {
    if [ -z "$CURRENT_THEME" ]; then
        echo -e "${RED}âŒ Uso:${RESET} theme-switch <nome-do-tema>"
        exit 1
    fi

    if [ ! -d "$THEMES_DIR/$CURRENT_THEME" ]; then
        echo -e "${RED}âŒ Tema '${CURRENT_THEME}' nÃ£o encontrado em:${RESET} $THEMES_DIR"
        exit 1
    fi

    echo -e "${BLUE}ğŸ¨ Aplicando tema:${RESET} ${YELLOW}${CURRENT_THEME}${RESET}"
}

apply_theme_files() {
    link_safe "$THEMES_DIR/$CURRENT_THEME/hypr/hyprland.conf" "$HYPR_DIR/hyprland.conf" "Hyprland"
    link_safe "$THEMES_DIR/$CURRENT_THEME/hypr/hyprpaper.conf" "$HYPR_DIR/hyprpaper.conf" "Hyprpaper"
    link_safe "$THEMES_DIR/$CURRENT_THEME/hypr/hyprlock.conf" "$HYPR_DIR/hyprlock.conf" "Hyprlock"
    link_safe "$THEMES_DIR/$CURRENT_THEME/kitty/kitty.conf" "$KITTY_DIR/kitty.conf" "Kitty"
    link_safe "$THEMES_DIR/$CURRENT_THEME/fastfetch/fastfetch.jsonc" "$FASTFETCH_DIR/config.jsonc" "Fastfetch"
    link_safe "$THEMES_DIR/$CURRENT_THEME/waybar/config.jsonc" "$WAYBAR_DIR/config.jsonc" "Waybar Config"
    link_safe "$THEMES_DIR/$CURRENT_THEME/waybar/style.css" "$WAYBAR_DIR/style.css" "Waybar CSS"
}

apply_wallpapers() {
    local theme_wallpapers="$THEMES_DIR/$CURRENT_THEME/wallpapers"

    if [ -d "$theme_wallpapers" ]; then
        [ -L "$HOME_WALLPAPERS" ] || [ -d "$HOME_WALLPAPERS" ] && rm -rf "$HOME_WALLPAPERS"
        ln -s "$theme_wallpapers" "$HOME_WALLPAPERS"
        echo -e "${GREEN}âœ”${RESET} Wallpapers do tema '${CURRENT_THEME}' aplicados"
    else
        echo -e "${YELLOW}âš  Pasta de wallpapers ausente no tema${RESET}"
    fi
}

manage_animated_wallpaper() {
    # Mata mpvpaper em todos os temas, exceto no animado
    pgrep -x "mpvpaper" &>/dev/null && killall mpvpaper &>/dev/null

    if [[ "$CURRENT_THEME" == "call-of-duty-theme" ]]; then
        echo -e "${BLUE}ğŸ Iniciando wallpaper animado...${RESET}"
        pkill -9 hyprpaper 2>/dev/null &
        sleep 0.5
        mpvpaper -o "no-audio loop --no-osc --panscan=1.0" eDP-1 "$HOME/wallpapers/ghost.mp4" &>/dev/null &
    fi
}

reload_services() {
    echo -e "\n${BLUE}ğŸ” Recarregando ambientes...${RESET}"
    hyprctl reload &>/dev/null

    if [[ "$CURRENT_THEME" != "call-of-duty-theme" ]]; then
        pgrep -x "hyprpaper" &>/dev/null && killall hyprpaper &>/dev/null
        hyprpaper &>/dev/null &
    fi

    if pgrep -x "waybar" &>/dev/null; then
        killall waybar &>/dev/null
        waybar &>/dev/null &
    fi
}

apply_gtk_theme() {
    local GTK_DIR_SRC="$THEMES_DIR/$CURRENT_THEME/gtk"
    local GTK_SRC="$GTK_DIR_SRC/settings.ini"
    local GTK_CSS_SRC="$GTK_DIR_SRC/gtk.css"

    local GTK3_DEST="$HOME/.config/gtk-3.0/settings.ini"
    local GTK4_DEST="$HOME/.config/gtk-4.0/settings.ini"
    local GTK3_CSS_DEST="$HOME/.config/gtk-3.0/gtk.css"
    local GTK4_CSS_DEST="$HOME/.config/gtk-4.0/gtk.css"

    mkdir -p "$(dirname "$GTK3_DEST")" "$(dirname "$GTK4_DEST")"
    mkdir -p "$(dirname "$GTK3_CSS_DEST")" "$(dirname "$GTK4_CSS_DEST")"

    link_safe "$GTK_SRC" "$GTK3_DEST" "GTK3 settings.ini"
    link_safe "$GTK_SRC" "$GTK4_DEST" "GTK4 settings.ini"

    [[ -f "$GTK_CSS_SRC" ]] && link_safe "$GTK_CSS_SRC" "$GTK3_CSS_DEST" "GTK3 CSS"
    [[ -f "$GTK_CSS_SRC" ]] && link_safe "$GTK_CSS_SRC" "$GTK4_CSS_DEST" "GTK4 CSS"

    if [[ -f "$GTK_SRC" ]]; then
        GTK_THEME_NAME=$(grep "gtk-theme-name" "$GTK_SRC" | cut -d'=' -f2 | xargs)
        CURSOR_THEME_NAME=$(grep "gtk-cursor-theme-name" "$GTK_SRC" | cut -d'=' -f2 | xargs)

        export GTK_THEME="$GTK_THEME_NAME"
        export XCURSOR_THEME="$CURSOR_THEME_NAME"
        export XCURSOR_SIZE=24
    fi
}

apply_firefox_theme() {
    local FF_PROFILE
    FF_PROFILE=$(grep -A1 '^\[Profile[0-9]*\]' "$FIREFOX_DIR/profiles.ini" \
        | grep 'Default=1' -B1 | grep 'Path=' | cut -d'=' -f2 | head -n1)

    if [[ -n "$FF_PROFILE" ]]; then
        local FF_PROFILE_PATH="$FIREFOX_DIR/$FF_PROFILE"
        mkdir -p "$FF_PROFILE_PATH/chrome"
        link_safe "$THEMES_DIR/$CURRENT_THEME/firefox/chrome/userChrome.css" \
                  "$FF_PROFILE_PATH/chrome/userChrome.css" "Firefox userChrome.css"

        pgrep -x "firefox" &>/dev/null && pkill firefox && firefox &>/dev/null &
    else
        echo -e "${YELLOW}âš  Firefox profile nÃ£o encontrado.${RESET}"
    fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  ExecuÃ§Ã£o
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
check_theme
apply_theme_files
apply_wallpapers
manage_animated_wallpaper
reload_services
apply_gtk_theme
apply_firefox_theme

echo -e "\n${GREEN}âœ… '${CURRENT_THEME}' aplicado com sucesso!${RESET}"
