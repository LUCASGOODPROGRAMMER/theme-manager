#!/bin/bash
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Gerenciador de temas minimalista para Hyprland
#  Autor: Lucas Nascimento Hubner âœ¨
#  Estrutura esperada:
#  ~/.config/themes/<nome-do-tema>/{hypr, kitty, waybar, fastfetch}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -euo pipefail  # Para abortar em erros e variÃ¡veis nÃ£o definidas

# DiretÃ³rios principais
THEMES_DIR="$HOME/.config/themes"
HYPR_DIR="$HOME/.config/hypr"
KITTY_DIR="$HOME/.config/kitty"
FASTFETCH_DIR="$HOME/.config/fastfetch"
WAYBAR_DIR="$HOME/.config/waybar"
FIREFOX_DIR="$HOME/.mozilla/firefox"
CURRENT_THEME="${1:-}"

# Cores para terminal
GREEN="\e[1;32m"
RED="\e[1;31m"
YELLOW="\e[1;33m"
BLUE="\e[1;34m"
RESET="\e[0m"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  VerificaÃ§Ãµes iniciais
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -z "$CURRENT_THEME" ]; then
    echo -e "${RED}âŒ Uso:${RESET} theme-switch <nome-do-tema>"
    exit 1
fi

if [ ! -d "$THEMES_DIR/$CURRENT_THEME" ]; then
    echo -e "${RED}âŒ Tema '${CURRENT_THEME}' nÃ£o encontrado em:${RESET} $THEMES_DIR"
    exit 1
fi

echo -e "${BLUE}ğŸ¨ Aplicando tema:${RESET} ${YELLOW}${CURRENT_THEME}${RESET}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  FunÃ§Ã£o auxiliar para links simbÃ³licos seguros
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
link_safe() {
    local src="$1"
    local dest="$2"
    local label="$3"

    if [ -e "$src" ]; then
        mkdir -p "$(dirname "$dest")"
        [ -e "$dest" ] && rm -rf "$dest"
        ln -sf "$src" "$dest"
        echo -e "${GREEN}âœ”${RESET} $label aplicado"
    else
        echo -e "${YELLOW}âš ${RESET} $label ausente em $src"
    fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Aplicar os temas
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
link_safe "$THEMES_DIR/$CURRENT_THEME/hypr/hyprland.conf" "$HYPR_DIR/hyprland.conf" "Hyprland"
link_safe "$THEMES_DIR/$CURRENT_THEME/hypr/hyprpaper.conf" "$HYPR_DIR/hyprpaper.conf" "Hyprpaper"
# link_safe "$THEMES_DIR/$CURRENT_THEME/hypr/hyprlock.conf" "$HYPR_DIR/hyprlock.conf" "Hyprlock"
link_safe "$THEMES_DIR/$CURRENT_THEME/kitty/kitty.conf" "$KITTY_DIR/kitty.conf" "Kitty"
link_safe "$THEMES_DIR/$CURRENT_THEME/fastfetch/fastfetch.jsonc" "$FASTFETCH_DIR/config.jsonc" "Fastfetch"
link_safe "$THEMES_DIR/$CURRENT_THEME/waybar/config.jsonc" "$WAYBAR_DIR/config.jsonc" "Waybar Config"
link_safe "$THEMES_DIR/$CURRENT_THEME/waybar/style.css" "$WAYBAR_DIR/style.css" "Waybar CSS"

# Substitui a pasta ~/wallpapers pelo tema atual
THEME_WALLPAPERS="$THEMES_DIR/$CURRENT_THEME/wallpapers"
HOME_WALLPAPERS="$HOME/wallpapers"

if [ -d "$THEME_WALLPAPERS" ]; then
    # Remove ou renomeia a pasta atual (opcional: backup)
    if [ -L "$HOME_WALLPAPERS" ] || [ -d "$HOME_WALLPAPERS" ]; then
        rm -rf "$HOME_WALLPAPERS"
    fi

    # Cria link simbÃ³lico direto
    ln -s "$THEME_WALLPAPERS" "$HOME_WALLPAPERS"
    echo -e "${GREEN}âœ”${RESET} Wallpapers do tema '${CURRENT_THEME}' aplicados"
else
    echo -e "${YELLOW}âš  Pasta de wallpapers ausente no tema${RESET}"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Gerenciar wallpapers animados
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Mata mpvpaper em todos os temas, exceto no animado
if pgrep -x "mpvpaper" >/dev/null; then
    killall mpvpaper &>/dev/null
fi

# Se o tema atual for o tema com vÃ­deo, inicia o mpvpaper
if [[ "$CURRENT_THEME" == "call-of-duty-theme" ]]; then
    echo -e "${BLUE}ğŸ Iniciando wallpaper animado...${RESET}"
    # Mata o hyprpaper se estiver em execuÃ§Ã£o
    if pgrep -x "hyprpaper" >/dev/null; then
        echo -e "${YELLOW}ğŸ§¹ Matando hyprpaper...${RESET}"
        pkill -9 hyprpaper
        sleep 1
    fi

    sleep 2
    # Inicia o vÃ­deo como wallpaper
    mpvpaper -o "no-audio loop --no-osc --panscan=1.0" eDP-1 "$HOME/wallpapers/ghost.mp4" &>/dev/null &
fi


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Reiniciar serviÃ§os
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\n${BLUE}ğŸ” Recarregando ambientes...${RESET}"
hyprctl reload &>/dev/null

if pgrep -x "hyprpaper" >/dev/null; then
    killall hyprpaper &>/dev/null
fi
hyprpaper &>/dev/null &

if pgrep -x "waybar" >/dev/null; then
    killall waybar &>/dev/null
    waybar &>/dev/null &
fi

# === GTK com link_safe ===
GTK_DIR_SRC="$THEMES_DIR/$CURRENT_THEME/gtk"
GTK_SRC="$GTK_DIR_SRC/settings.ini"
GTK_CSS_SRC="$GTK_DIR_SRC/gtk.css"

GTK3_DEST="$HOME/.config/gtk-3.0/settings.ini"
GTK4_DEST="$HOME/.config/gtk-4.0/settings.ini"
GTK3_CSS_DEST="$HOME/.config/gtk-3.0/gtk.css"
GTK4_CSS_DEST="$HOME/.config/gtk-4.0/gtk.css"

# Cria diretÃ³rios se nÃ£o existirem
mkdir -p "$(dirname "$GTK3_DEST")" "$(dirname "$GTK4_DEST")"
mkdir -p "$(dirname "$GTK3_CSS_DEST")" "$(dirname "$GTK4_CSS_DEST")"

# Aplica links simbÃ³licos de forma segura
link_safe "$GTK_SRC" "$GTK3_DEST" "GTK3 settings.ini"
link_safe "$GTK_SRC" "$GTK4_DEST" "GTK4 settings.ini"

if [[ -f "$GTK_CSS_SRC" ]]; then
    link_safe "$GTK_CSS_SRC" "$GTK3_CSS_DEST" "GTK3 CSS"
    link_safe "$GTK_CSS_SRC" "$GTK4_CSS_DEST" "GTK4 CSS"
fi

# Exporta variÃ¡veis de ambiente
if [[ -f "$GTK_SRC" ]]; then
    GTK_THEME_NAME=$(grep "gtk-theme-name" "$GTK_SRC" | cut -d'=' -f2 | xargs)
    CURSOR_THEME_NAME=$(grep "gtk-cursor-theme-name" "$GTK_SRC" | cut -d'=' -f2 | xargs)
    
    export GTK_THEME="$GTK_THEME_NAME"
    export XCURSOR_THEME="$CURSOR_THEME_NAME"
    export XCURSOR_SIZE=24
fi

# === Firefox com link_safe ===
FF_PROFILE=$(grep -A1 '^\[Profile[0-9]*\]' "$FIREFOX_DIR/profiles.ini" | grep 'Default=1' -B1 | grep 'Path=' | cut -d'=' -f2 | head -n1)

if [[ -n "$FF_PROFILE" ]]; then
    FF_PROFILE_PATH="$FIREFOX_DIR/$FF_PROFILE"
    mkdir -p "$FF_PROFILE_PATH/chrome"
    link_safe "$THEMES_DIR/$CURRENT_THEME/firefox/chrome/userChrome.css" "$FF_PROFILE_PATH/chrome/userChrome.css" "Firefox userChrome.css"

    # Reinicia o Firefox se estiver aberto
    if pgrep -x "firefox" >/dev/null; then
        pkill firefox
        firefox &>/dev/null &
    fi
else
    echo -e "${YELLOW}âš  Firefox profile nÃ£o encontrado.${RESET}"
fi

echo -e "\n${GREEN}âœ… '${CURRENT_THEME}' aplicado com sucesso!${RESET}"
